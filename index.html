<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Study Tracker</title>

<link rel="manifest" href="manifest.json">

<style>
:root{
 --primary:#22c55e;
 --bg:#eef3f8;
 --glass:rgba(255,255,255,.65);
 --text:#0f172a;
 --shadow:0 12px 35px rgba(0,0,0,.12);
}
.dark{
 --bg:#08111f;
 --glass:rgba(30,41,59,.55);
 --text:#f8fafc;
}
body{
 margin:0;
 font-family:Segoe UI;
 background:var(--bg);
 color:var(--text);
 overflow-x:hidden;
}
#particles{
 position:fixed;
 inset:0;
 z-index:0;
 pointer-events:none;
}
header{
 background:linear-gradient(135deg,#22c55e,#16a34a);
 color:white;
 text-align:center;
 padding:14px;
 font-size:22px;
 font-weight:600;
}
header,.main,.bottom{position:relative;z-index:1;}
.main{
 display:grid;
 grid-template-columns:1fr 1.5fr 1fr;
 gap:16px;
 padding:16px;
 padding-bottom:90px;
}
@media(max-width:900px){
 .main{grid-template-columns:1fr;padding:10px;}
}
.card{
 background:var(--glass);
 backdrop-filter:blur(12px);
 border-radius:16px;
 padding:14px;
 box-shadow:var(--shadow);
 margin-bottom:12px;
}
.subject{
 padding:10px;
 border-radius:10px;
 background:rgba(34,197,94,.15);
 margin-bottom:6px;
 cursor:pointer;
}
.subject.active{background:#22c55e;color:white;}
.topic{
 background:rgba(255,255,255,.6);
 padding:10px;
 border-radius:12px;
 margin-top:10px;
}
.dark .topic{background:rgba(15,23,42,.6);}
.progress{
 height:10px;
 background:#ddd;
 border-radius:10px;
 margin:10px 0 14px;
 overflow:hidden;
}
.fill{
 height:100%;
 background:linear-gradient(90deg,#22c55e,#4ade80);
}
.days{
 display:flex;
 gap:10px;
 overflow-x:auto;
}
.tick{
 width:34px;height:34px;
 border:2px solid #22c55e;
 border-radius:10px;
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 background:white;
}
.dark .tick{background:#08111f;}
.tick.checked{background:#22c55e;color:white;}
.small{text-align:center;font-size:11px}
.big{font-size:28px;font-weight:bold;color:#22c55e;}
.bottom{
 position:fixed;
 bottom:10px;
 left:50%;
 transform:translateX(-50%);
 background:var(--glass);
 padding:8px 14px;
 border-radius:12px;
 display:flex;
 gap:8px;
}
button{
 background:#22c55e;
 color:white;
 border:none;
 padding:7px 12px;
 border-radius:10px;
 cursor:pointer;
}
</style>
</head>

<body>

<canvas id="particles"></canvas>
<header>Tracking Progress üöÄ</header>

<div class="main">
  <div id="left"></div>
  <div id="center"></div>
  <div id="right"></div>
</div>

<div class="bottom">
  <button onclick="toggleTheme()">üåô Theme</button>
  <button onclick="addSubject()">+ Subject</button>
  <button id="loginBtn" onclick="login()">üîê Login</button>
  <button id="logoutBtn" onclick="logout()" style="display:none">üö™ Logout</button>
  <button id="installBtn" style="display:none">‚¨á Install</button>
</div>

<!-- üî• FIREBASE AUTH (FIXED) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithRedirect,
  signInWithPopup,   // üëà ADD THIS LINE
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAl6_USkJ4K2fM4shbtEDCOwH-QO5SU4ks",
  authDomain: "study-tracker-ir.firebaseapp.com",
  projectId: "study-tracker-ir",
  storageBucket: "study-tracker-ir.firebasestorage.app",
  messagingSenderId: "824985015855",
  appId: "1:824985015855:web:ee35ed66ba20a5d79918da"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

window.isLoggedIn = false;
let user = null;

/* AUTH STATE ‚Äî SINGLE SOURCE OF TRUTH */
onAuthStateChanged(auth, async (u) => {
  if (u) {
    user = u;
    window.isLoggedIn = true;
    await loadCloud();
  } else {
    user = null;
    window.isLoggedIn = false;
  }
  syncAuthUI();
});

/* LOGIN / LOGOUT */
window.login = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    console.error("Login failed:", e);
  }
};


window.logout = () => signOut(auth);

/* CLOUD */
async function loadCloud(){
  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);
  if(snap.exists()){
    data = snap.data();
    localStorage.setItem("unicorn",JSON.stringify(data));
    render();
  }
}

window.cloudSave = async function(data){
  if(user) await setDoc(doc(db,"users",user.uid),data);
};
</script>

<script>
function syncAuthUI(){
  loginBtn.style.display = window.isLoggedIn ? "none" : "inline-block";
  logoutBtn.style.display = window.isLoggedIn ? "inline-block" : "none";
}

/* ===== DATA ===== */
let data=JSON.parse(localStorage.getItem("unicorn"))||{subjects:[],xp:0};
let selected=0;

/* THEME */
let theme=localStorage.getItem("theme");
if(theme==="dark") document.body.classList.add("dark");
function toggleTheme(){
 document.body.classList.toggle("dark");
 localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");
}

/* SAVE */
function save(){
 localStorage.setItem("unicorn",JSON.stringify(data));
 if(window.cloudSave) cloudSave(data);
}

/* PROGRESS + RENDER (UNCHANGED) */
function percent(t){let d=0;for(let i=1;i<=31;i+=2) if(t.progress[i]) d++;return Math.round(d/16*100);}
function overall(){let s=0,c=0;data.subjects.forEach(a=>a.topics.forEach(t=>{s+=percent(t);c++;}));return c?Math.round(s/c):0;}

function addSubject(){let n=prompt("Subject name");if(!n)return;data.subjects.push({name:n,topics:[]});save();render();}
function deleteSubject(i){if(confirm("Delete subject?")){data.subjects.splice(i,1);selected=0;save();render();}}
function selectSub(i){selected=i;render();}

function addTopic(){let n=prompt("Topic name");if(!n)return;data.subjects[selected].topics.push({name:n,progress:{}});save();render();}
function deleteTopic(j){if(confirm("Delete topic?")){data.subjects[selected].topics.splice(j,1);save();render();}}
function toggle(i,j,d){let t=data.subjects[i].topics[j];t.progress[d]=!t.progress[d];data.xp+=5;save();render();}

function render(){
 renderLeft();renderCenter();renderRight();syncAuthUI();
}

function renderLeft(){
 left.innerHTML=`<div class="card"><h3>üìö Subjects</h3>
 ${data.subjects.map((s,i)=>`<div class="subject ${selected===i?'active':''}" onclick="selectSub(${i})">${s.name}
 <span style="float:right" onclick="event.stopPropagation();deleteSubject(${i})">‚ùå</span></div>`).join('')}</div>`;
}
function renderCenter(){
 if(!data.subjects[selected]){center.innerHTML=`<div class="card">Add subject üëç</div>`;return;}
 let s=data.subjects[selected];
 center.innerHTML=`<div class="card"><h3>${s.name} <button onclick="addTopic()">+ Topic</button></h3>
 ${s.topics.map((t,j)=>`
 <div class="topic">
 <b>${t.name}</b> <span style="float:right" onclick="deleteTopic(${j})">‚ùå</span>
 (${percent(t)}%)
 <div class="progress"><div class="fill" style="width:${percent(t)}%"></div></div>
 <div class="days">${[...Array(16)].map((_,k)=>{
   let d=1+k*2;return `<div class="small"><div class="tick ${t.progress[d]?'checked':''}" onclick="toggle(${selected},${j},${d})">‚úî</div>${d}</div>`;
 }).join('')}</div></div>`).join('')}</div>`;
}
function renderRight(){
 right.innerHTML=`<div class="card"><h3>üìä Dashboard</h3><div class="big">${data.xp}</div>XP Points
 <p><b>Overall:</b> ${overall()}%</p>
 <div class="progress"><div class="fill" style="width:${overall()}%"></div></div></div>`;
}


/* ===== LIVE ANALYTICS ===== */

function drawLiveAnalytics(){
  const c = document.getElementById("liveChart");
  if(!c) return;

  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  let values=[];
  data.subjects.forEach(s =>
    s.topics.forEach(t => values.push(percent(t)))
  );

  if(values.length===0) return;

  ctx.beginPath();
  ctx.moveTo(0,160);

  values.forEach((v,i)=>{
    ctx.lineTo((i+1)*35,160-v*1.3);
  });

  ctx.strokeStyle="#22c55e";
  ctx.lineWidth=3;
  ctx.stroke();
}

function injectAnalytics(){
  const right=document.getElementById("right");
  if(!right) return;

  if(document.getElementById("liveChart")) return;

  right.innerHTML += `
    <div class="card">
      <h3>üìà Live Analytics</h3>
      <canvas id="liveChart" width="300" height="180"></canvas>
    </div>
  `;
  setTimeout(drawLiveAnalytics,100);
}

/* hook analytics into render */
const _render = render;
render = function(){
  _render();
  injectAnalytics();
};



render();
</script>
</body>
</html>
